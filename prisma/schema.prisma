// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

// --- Multi-Tenancy Core ---

model Company {
  id        String   @id @default(cuid())
  name      String
  address   String?
  workingHours String? // JSON: { "mon": { "start": "09:00", "end": "18:00", "closed": false }, ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lots           Lot[]
  contacts       CompanyContact[]
  members        CompanyMember[]
  roles          Role[]
  vehicles       Vehicle[]
  serviceTickets ServiceTicket[]
  inspections    Inspection[]
  tasks          Task[]
  deposits       Deposit[]
}

model CompanyContact {
  id        String   @id @default(cuid())
  type      String   // PHONE, EMAIL
  value     String
  label     String?
  
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Lot {
  id        String   @id @default(cuid())
  name      String
  address   String?
  workingHours String? // JSON
  timezone     String? @default("America/Chicago")

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  contacts       LotContact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vehicles       Vehicle[]
  serviceTickets ServiceTicket[]
  inspections    Inspection[]
  companyMembers CompanyMember[]
  accessibleBy   CompanyMember[] @relation("MemberAccessibleLots")
}

model LotContact {
  id        String   @id @default(cuid())
  lotId     String
  lot       Lot      @relation(fields: [lotId], references: [id], onDelete: Cascade)
  type      String
  value     String
  label     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id            String    @id @default(cuid())
// ... existing User fields unchanged
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  
  // App-specific
  currentLotId String? // Last visited context

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships     CompanyMember[]
  assignedTickets ServiceTicket[] // Historical record
  timeLogs        TimeLog[]
  tasks           Task[] // Assigned tasks
}

model CompanyMember {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Specific assignments
  lotId     String? 
  lot       Lot?     @relation(fields: [lotId], references: [id])
  
  accessibleLots Lot[] @relation("MemberAccessibleLots")

  // Roles assigned to this member in this company
  roles     Role[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
}

model Role {
  id          String  @id @default(cuid())
  name        String
  description String?
  isSystem    Boolean @default(false) // If true, cannot be deleted (e.g. Owner)
  
  companyId   String? // Null for System Templates (if we used them), but for now every company has copies
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  permissions RolePermission[]
  members     CompanyMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id          String @id @default(cuid())
  action      String // create, read, update, delete
  resource    String // vehicle, ticket, user
  
  // Roles that have this permission
  roles       RolePermission[]

  @@unique([action, resource])
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

// --- NextAuth.js Standard Models ---

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- Business Entities (Scoped) ---

model Vehicle {
  // Core Details
  vin           String   @id
  stockNumber   String?
  year          Int
  make          String
  model         String
  trim          String?
  bodyStyle     String?
  color         String?
  interiorColor String?
  odometer      Int      @default(0)
  condition     String?  @default("Used")
  titleStatus   String?  @default("Clean")
  keyId         String?

  // Performance & Specs
  engine          String?
  engineSize      String?
  engineCylinders Int?
  transmission    String?
  transmissionType String?
  transmissionSpeeds Int?
  driveTrain      String?
  fuelType        String?
  doors           Int?
  cityMpg         Int?
  highwayMpg      Int?
  interiorOemColor String?
  exteriorOemColor String?
  vehicleCaption  String?
  category        String?
  size            String?

  // Equipment
  vehicleEquipment String?
  windowStickerEquipment String?

  // Logistics
  location    String? // Text description, distinct from Lot
  salesPerson String?
  salesNotes  String?
  guarantee   String?
  googleDriveUrl String?
  walkaroundVideo String?
  testDriveVideo String?

  // Manufacture Details
  plantCity    String?
  plantState   String?
  plantCountry String?
  grossWeight  String?

  // Financials
  purchasePrice  Decimal @default(0)
  salePrice      Decimal @default(0)
  regularPrice   Decimal?
  cashPrice      Decimal?
  wholesalePrice Decimal?
  loanValue      Decimal?
  msrp           Decimal?
  exportPrice    Decimal?
  blueBook       Decimal?
  blackBook      Decimal?
  edmundsBook    Decimal?
  nadaBook       Decimal?
  downPayment    Decimal?
  monthlyPayment Decimal?
  biWeeklyPayment Decimal?
  weeklyPayment   Decimal?
  vehicleCost     Decimal?
  repairCost      Decimal?
  bottomLinePrice Decimal?
  preferredPriceText String?
  salePriceExpires DateTime?
  tax            Decimal @default(0)
  total          Decimal @default(0)
  balance        Decimal @default(0)

  // Flags
  isFeatured         Boolean @default(false)
  isCertified        Boolean @default(false)
  isOneOwner         Boolean @default(false)
  warrantyAvailable  Boolean @default(false)
  financingAvailable Boolean @default(false)
  isSold             Boolean @default(false)
  isNew              Boolean @default(false)
  isAsIs             Boolean @default(false)
  
  // Description Builder Flags (Combined for brevity, but can be expanded if needed)
  flagLowMiles       Boolean @default(false)
  flagNonSmoker      Boolean @default(false)
  flagFullService    Boolean @default(false)
  flagMultiPoint     Boolean @default(false)
  flagNeverWrecked   Boolean @default(false)
  flagFullyEquipped  Boolean @default(false)
  flagLuxury         Boolean @default(false)
  flagPowerful       Boolean @default(false)
  flagFuelEfficient  Boolean @default(false)
  flagSporty         Boolean @default(false)
  flagOffRoad        Boolean @default(false)
  flagMechanicallyPerfect Boolean @default(false)
  flagPerfectExterior Boolean @default(false)
  flagPerfectInterior Boolean @default(false)
  flagCleanExterior   Boolean @default(false)
  flagCleanInterior   Boolean @default(false)
  flagBelowBlueBook   Boolean @default(false)
  flagLowMonthly      Boolean @default(false)
  flagBhph            Boolean @default(false)
  flagGuaranteedFin   Boolean @default(false)
  flagCarfaxReport    Boolean @default(false)
  flagCarfaxCertified Boolean @default(false)
  flagCarfaxOneOwner  Boolean @default(false)
  flagAutocheckReport Boolean @default(false)
  flagAutocheckCert   Boolean @default(false)
  flagAutocheckOne    Boolean @default(false)

  // SEO
  seoTitle       String?
  seoKeywords    String?
  seoDescription String?

  status String @default("PURCHASED")

  // Scoping & Safety
  companyId         String
  company           Company @relation(fields: [companyId], references: [id])
  lotId             String?
  lot               Lot?    @relation(fields: [lotId], references: [id])
  markedForDeletion Boolean @default(false)
  deletedAt         DateTime?
  deletedBy         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  images         VehicleImage[]
  serviceTickets ServiceTicket[]
  deposits       Deposit[]
  tasks          Task[]
  priceHistory   PriceHistory[]
  inspections    Inspection[]
}

model VehicleImage {
  id        String  @id @default(cuid())
  driveId   String
  publicUrl String?
  isPublic  Boolean @default(false)
  order     Int     @default(0)
  mimeType  String?
  name      String?
  
  vehicleVin String
  vehicle    Vehicle @relation(fields: [vehicleVin], references: [vin], onDelete: Cascade)
}

model PriceHistory {
  id        String   @id @default(cuid())
  oldPrice  Decimal
  newPrice  Decimal
  date      DateTime @default(now())
  
  vehicleVin String
  vehicle    Vehicle @relation(fields: [vehicleVin], references: [vin], onDelete: Cascade)
}

// --- Service Module ---

model ServiceTicket {
  id          String   @id @default(cuid())
  description String
  status      String   @default("Queue") 
  
  vehicleVin String
  vehicle    Vehicle @relation(fields: [vehicleVin], references: [vin])
  
  techId String? // Legacy direct link, prefer using Assignee pattern if possible, but keeping for now
  tech   User?   @relation(fields: [techId], references: [id])

  repairProcess    String?
  repairDifficulty String?

  inspectionId String?
  inspection   Inspection? @relation(fields: [inspectionId], references: [id])

  // Scoping & Safety
  companyId         String
  company           Company @relation(fields: [companyId], references: [id])
  lotId             String?
  lot               Lot?    @relation(fields: [lotId], references: [id])
  markedForDeletion Boolean @default(false)
  deletedAt         DateTime?
  deletedBy         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parts    Part[]
  timeLogs TimeLog[]
}

model Part {
  id             String  @id @default(cuid())
  name           String
  vendor         String?
  trackingNumber String?
  cost           Decimal @default(0)
  status         String  @default("ORDERED")
  
  ticketId String
  ticket   ServiceTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model TimeLog {
  id        String    @id @default(cuid())
  startTime DateTime  @default(now())
  endTime   DateTime?
  type      String    @default("PRODUCTIVE")
  notes     String?
  
  status      String?
  tasks       String?
  workDetails String?
  
  ticketId String?
  ticket   ServiceTicket? @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id])

  companyId String? // Optional for now, but good for reporting
}

model Deposit {
  id           String   @id @default(cuid())
  amount       Decimal
  method       String
  buyerName    String
  date         DateTime @default(now())
  expiryDate   DateTime
  notes        String?
  
  vehicleVin String
  vehicle    Vehicle @relation(fields: [vehicleVin], references: [vin])
  
  // Scoping
  companyId         String
  company           Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
}

model Task {
  id          String   @id @default(cuid())
  description String
  status      String   @default("PENDING")
  
  vehicleVin String?
  vehicle    Vehicle? @relation(fields: [vehicleVin], references: [vin])
  
  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  // Scoping
  companyId         String
  company           Company @relation(fields: [companyId], references: [id])
}

model Inspection {
  id          String   @id @default(cuid())
  name        String
  date        DateTime @default(now())
  info        String?
  
  vehicleVin String
  vehicle    Vehicle @relation(fields: [vehicleVin], references: [vin])
  
  codes      InspectionCode[]
  
  needsMechanicalRecon Boolean @default(false)
  needsCosmeticRecon   Boolean @default(false)
  
  mechanicalReconData String?
  cosmeticReconData   String?

  serviceTickets ServiceTicket[]
  
  // Scoping
  companyId         String
  company           Company @relation(fields: [companyId], references: [id])
  lotId             String?
  lot               Lot?    @relation(fields: [lotId], references: [id])
  markedForDeletion Boolean @default(false)
  deletedAt         DateTime?
  deletedBy         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InspectionCode {
  id          String   @id @default(cuid())
  code        String
  description String?
  
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
}
